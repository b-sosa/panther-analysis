AnalysisType: scheduled_query
QueryName: Snowflake.BruteForceByIp
Enabled: false
Description: >
  Detect brute force attempts by monitoring for failed logins to snowflake
SnowflakeQuery: >
  --return IPs with more than 5 failed logins in the previous 24 hours
  --this was adapted from a SnowAlert query
  SELECT 
    client_ip,
    MIN(event_timestamp) event_start,
    MAX(event_timestamp) event_end,
    timediff(second, event_start, event_end) as event_duration,
    reported_client_type,
    ARRAY_AGG(DISTINCT error_code),
    ARRAY_AGG(DISTINCT error_message),
    COUNT(event_id) AS counts
  FROM snowflake.account_usage.login_history
  WHERE 1=1
    AND DATEDIFF(HOUR,  event_timestamp, CURRENT_TIMESTAMP) < 24
    AND error_code IS NOT NULL
  GROUP BY client_ip, reported_client_type
  HAVING counts >= 5;
Schedule:
  RateMinutes: 60
  TimeoutMinutes: 1
